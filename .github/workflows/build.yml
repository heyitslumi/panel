name: Release

on:
  push:
    branches:
      - main
      - nightly
  workflow_dispatch: # Allows you to run it manually from the "Actions" tab

env:
  BIN_NAME: panel-rs
  PROJECT_NAME: panel-rs

jobs:
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10
          run_install: false

      - name: Get pnpm store directory
        id: pnpm-cache
        run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install frontend dependencies
        run: |
          cd frontend
          pnpm install

      - name: Build frontend
        run: |
          cd frontend
          export NODE_OPTIONS="--max-old-space-size=4096"
          pnpm build

      - name: Upload frontend build
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist/

  dist:
    name: Build ARMv7 Binary
    needs: [build-frontend]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - build: armv7-linux
            target: armv7-unknown-linux-musleabihf # Best for 32-bit ARM on Android TV
            binary_suffix: ""

    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Download frontend build
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist/

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          target: ${{ matrix.target }}

      - name: Install cross
        if: contains(matrix.target, 'linux')
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: ${{ runner.os }}-${{ matrix.target }}

      - name: Run tests (Linux)
        if: contains(matrix.target, 'linux')
        run: cross test --target ${{ matrix.target }}

      - name: Build release binary (Linux)
        if: contains(matrix.target, 'linux')
        run: |
          RUSTFLAGS="-C target-feature=+crt-static" \
          cross build --release --target ${{ matrix.target }}

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PROJECT_NAME }}-${{ matrix.build }}
          path: target/${{ matrix.target }}/release/${{ env.BIN_NAME }}${{ matrix.binary_suffix }}
